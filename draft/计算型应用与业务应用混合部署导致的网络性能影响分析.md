```bash
# kubelet -h | grep cpu-manager-policy
      --cpu-manager-policy string    
      CPU Manager policy to use. 
      Possible values: 'none', 'static'. 
      Default: 'none' (default "none") 
      (DEPRECATED: 
        This parameter should be set via the config file specified by the Kubelet's --config flag.
        See https://kubernetes.io/docs/tasks/administer-cluster/kubelet-config-file/ for more information.)
```
### 猜想1 - CPU计算争抢CPU资源导致网络中断不及时
实验：去掉CPU计算，仅保留数据拉取

#### 实验前后数据对比
CPU使用率（POD）对比
```bash
# 实验前
✗ kubectl top pod -n monitoring prometheus-ecs-0
NAME               CPU(cores)   MEMORY(bytes)   
prometheus-ecs-0   2222m        5209Mi
# 实验后 
✗ kubectl top pod -n monitoring prometheus-ecs-0
NAME               CPU(cores)   MEMORY(bytes)   
prometheus-ecs-0   81m          2741Mi    
```
CPU使用情况对比
> 从数据中可以看出%sys，%soft没有明显变化，只是%usr使用率增加
```bash
# mpstat -P ALL 1
# 实验前
Average:     CPU    %usr   %nice    %sys %iowait    %irq   %soft  %steal  %guest  %gnice   %idle
Average:     all   19.89    0.10    4.31    0.13    0.00    3.00    0.00    0.00    0.00   72.57
Average:       0   30.46    0.00    6.09    0.00    0.00    3.55    0.00    0.00    0.00   59.90
Average:       1   10.95    0.50    2.99    0.00    0.00    1.99    0.00    0.00    0.00   83.58
Average:       2   27.32    0.00    5.15    0.52    0.00    3.61    0.00    0.00    0.00   63.40
Average:       3   11.17    0.00    3.55    0.00    0.00    2.03    0.00    0.00    0.00   83.25
Average:       4   34.18    0.00    5.61    0.00    0.00    3.06    0.00    0.00    0.00   57.14
Average:       5    8.67    0.51    2.55    0.00    0.00    3.06    0.00    0.00    0.00   85.20
Average:       6   27.78    0.00    6.57    0.51    0.00    4.04    0.00    0.00    0.00   61.11
Average:       7    9.28    0.52    3.09    0.00    0.00    3.09    0.00    0.00    0.00   84.02
Average:       8   26.94    0.00    6.22    0.00    0.00    3.63    0.00    0.00    0.00   63.21
Average:       9   10.42    0.00    2.60    0.00    0.00    3.12    0.00    0.00    0.00   83.85
Average:      10   28.12    0.00    4.69    0.52    0.00    3.12    0.00    0.00    0.00   63.54
Average:      11    9.79    0.00    2.58    0.00    0.00    3.61    0.00    0.00    0.00   84.02
Average:      12   40.82    0.00    4.59    0.00    0.00    3.06    0.00    0.00    0.00   51.53
Average:      13    7.58    0.00    2.02    0.00    0.00    2.02    0.00    0.00    0.00   88.38
Average:      14   26.15    0.00    6.67    0.00    0.00    3.08    0.00    0.00    0.00   64.10
Average:      15   10.15    0.00    3.05    0.00    0.00    1.02    0.00    0.00    0.00   85.79
# 实验后
03:56:21 PM  CPU    %usr   %nice    %sys %iowait    %irq   %soft  %steal  %guest  %gnice   %idle
03:56:22 PM  all   24.68    0.32    4.51    0.13    0.00    2.73    0.00    0.00    0.00   67.64
03:56:22 PM    0   28.87    0.00    6.19    0.00    0.00    3.09    0.00    0.00    0.00   61.86
03:56:22 PM    1   11.11    1.01    4.04    0.00    0.00    3.03    0.00    0.00    0.00   80.81
03:56:22 PM    2   30.69    0.00    4.95    0.99    0.00    3.96    0.00    0.00    0.00   59.41
03:56:22 PM    3   13.27    0.00    2.04    0.00    0.00    2.04    0.00    0.00    0.00   82.65
03:56:22 PM    4   27.55    0.00    6.12    0.00    0.00    4.08    0.00    0.00    0.00   62.24
03:56:22 PM    5   11.22    0.00    5.10    0.00    0.00    4.08    0.00    0.00    0.00   79.59
03:56:22 PM    6   33.67    1.02    5.10    0.00    0.00    3.06    0.00    0.00    0.00   57.14
03:56:22 PM    7   10.31    0.00    3.09    0.00    0.00    2.06    0.00    0.00    0.00   84.54
03:56:22 PM    8   28.57    0.00    6.12    0.00    0.00    3.06    0.00    0.00    0.00   62.24
03:56:22 PM    9   12.00    1.00    4.00    0.00    0.00    4.00    0.00    0.00    0.00   79.00
03:56:22 PM   10   27.84    0.00    5.15    0.00    0.00    3.09    0.00    0.00    0.00   63.92
03:56:22 PM   11   11.11    1.01    5.05    0.00    0.00    3.03    0.00    0.00    0.00   79.80
03:56:22 PM   12   28.87    0.00    8.25    0.00    0.00    3.09    0.00    0.00    0.00   59.79
03:56:22 PM   13   12.12    1.01    5.05    0.00    0.00    1.01    0.00    0.00    0.00   80.81
03:56:22 PM   14    9.00    0.00    1.00    0.00    0.00    1.00    0.00    0.00    0.00   89.00
03:56:22 PM   15  100.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00
```
网络吞吐，中断，上下文切换对比
> 磁盘读写没有明显变化，中断及上下文切换数量也没有明显增加
```bash
# dstat -cdngy
# 实验前
----total-cpu-usage---- -dsk/total- -net/total- ---paging-- ---system--
usr sys idl wai hiq siq| read  writ| recv  send|  in   out | int   csw 
 24   3  72   0   0   1|8236B  205k|   0     0 |   0     0 |  49k   47k
 48   5  44   0   0   3|   0  5124k|  28M   27M|   0     0 |  74k   63k
 36   4  57   0   0   3|   0     0 |  27M   27M|   0     0 |  73k   70k
 38   4  55   0   0   3|   0   292k|  27M   26M|   0     0 |  72k   67k
 39   5  54   0   0   3|   0   848k|  27M   27M|   0     0 |  76k   70k
 40   4  53   0   0   2|   0   228k|  26M   26M|   0     0 |  72k   68k
 48   4  45   0   0   3|   0  4096B|  26M   26M|   0     0 |  69k   64k
 # 实验后
----total-cpu-usage---- -dsk/total- -net/total- ---paging-- ---system--
usr sys idl wai hiq siq| read  writ| recv  send|  in   out | int   csw 
 23   3  72   0   0   1|2713B  195k|   0     0 |   0     0 |  48k   47k
 31   6  57   3   0   4|  40k  176M|  27M   26M|   0     0 |  80k   72k
 46   4  47   0   0   3|   0    20k|  26M   26M|   0     0 |  66k   58k
 27   5  65   0   0   3|   0   436k|  26M   25M|   0     0 |  72k   70k
 26   4  68   0   0   3|   0   864k|  25M   25M|   0     0 |  70k   69k
 31   4  62   0   0   3|   0   360k|  26M   26M|   0     0 |  71k   69k
 42   4  51   0   0   2|   0   208k|  25M   31M|   0     0 |  68k   62k
 51   4  42   0   0   3|   0     0 |  31M   30M|   0     0 |  69k   61k
 29   6  62   0   0   3|   0    12k|  25M   25M|   0     0 |  71k   67k
```
磁盘IO对比
> 
```bash
# iostat -xdm 1
# 实验前
Device:         rrqm/s   wrqm/s     r/s     w/s    rMB/s    wMB/s avgrq-sz avgqu-sz   await r_await w_await  svctm  %util
vda               0.00     0.00    0.00    0.00     0.00     0.00     0.00     0.00    0.00    0.00    0.00   0.00   0.00
vdb               0.00     0.00    0.00    0.00     0.00     0.00     0.00     0.00    0.00    0.00    0.00   0.00   0.00
vdc               0.00     1.00    0.00    2.00     0.00     0.01    12.00     0.00    0.50    0.00    0.50   0.00   0.00

Device:         rrqm/s   wrqm/s     r/s     w/s    rMB/s    wMB/s avgrq-sz avgqu-sz   await r_await w_await  svctm  %util
vda               0.00     0.00    0.00    0.00     0.00     0.00     0.00     0.00    0.00    0.00    0.00   0.00   0.00
vdb               0.00     0.00    0.00    0.00     0.00     0.00     0.00     0.00    0.00    0.00    0.00   0.00   0.00
vdc               0.00     0.00    0.00    0.00     0.00     0.00     0.00     0.00    0.00    0.00    0.00   0.00   0.00

Device:         rrqm/s   wrqm/s     r/s     w/s    rMB/s    wMB/s avgrq-sz avgqu-sz   await r_await w_await  svctm  %util
vda               0.00     0.00    0.00    0.00     0.00     0.00     0.00     0.00    0.00    0.00    0.00   0.00   0.00
vdb               0.00    23.00    0.00    3.00     0.00     0.29   194.67     0.00    1.67    0.00    1.67   1.33   0.40
vdc               0.00     0.00    0.00    0.00     0.00     0.00     0.00     0.00    0.00    0.00    0.00   0.00   0.00
# 实验后
Device:         rrqm/s   wrqm/s     r/s     w/s    rMB/s    wMB/s avgrq-sz avgqu-sz   await r_await w_await  svctm  %util
vda               0.00     1.11    0.02    4.62     0.00     0.03    11.86     0.02    5.31    1.44    5.32   0.12   0.06
vdb               0.00     7.90    0.00    6.04     0.00     0.16    55.45     0.04    7.97    1.54    7.97   0.32   0.19
vdc               0.00     0.00    0.02    0.01     0.00     0.00   378.84     0.00   47.23    1.53  193.57   1.10   0.00

Device:         rrqm/s   wrqm/s     r/s     w/s    rMB/s    wMB/s avgrq-sz avgqu-sz   await r_await w_await  svctm  %util
vda               0.00     9.00    1.00    2.00     0.01     0.04    34.67     0.01    3.67    9.00    1.00   3.33   1.00
vdb               0.00    31.00    0.00    8.00     0.00     0.15    39.00     0.01    1.62    0.00    1.62   0.38   0.30
vdc               0.00     0.00    0.00    0.00     0.00     0.00     0.00     0.00    0.00    0.00    0.00   0.00   0.00

Device:         rrqm/s   wrqm/s     r/s     w/s    rMB/s    wMB/s avgrq-sz avgqu-sz   await r_await w_await  svctm  %util
vda               0.00     0.00    0.00    0.00     0.00     0.00     0.00     0.00    0.00    0.00    0.00   0.00   0.00
vdb               0.00     0.00    0.00    0.00     0.00     0.00     0.00     0.00    0.00    0.00    0.00   0.00   0.00
vdc               0.00     4.00    0.00    3.00     0.00     0.20   138.67     0.00    1.33    0.00    1.33   1.00   0.30
```

#
```bash
# vmstat 1
procs -----------memory---------- ---swap-- -----io---- -system-- ------cpu-----
 r  b   swpd   free   buff  cache   si   so    bi    bo   in   cs us sy id wa st
11  0      0 28865288 459860 65950144    0    0     2    14    2    3 24  4 72  0  0
11  0      0 28861516 459860 65950496    0    0     0    12 75654 75219 39  9 52  0  0
14  0      0 28863200 459868 65951004    0    0     0    88 73277 68516 38  7 55  0  0
 5  0      0 28862424 459868 65951856    0    0     0     0 73039 68720 39  7 54  0  0
13  0      0 28862108 459868 65952232    0    0     0   904 73399 69807 32  7 61  0  0
 5  0      0 28861564 459868 65953196    0    0     0     0 73533 70310 27  7 66  0  0
 8  0      0 28860308 459868 65953944    0    0     0    92 73203 69402 32  7 61  0  0
 9  0      0 28856784 459876 65954424    0    0     0   232 77575 73702 26  8 66  0  0
17  0      0 28857556 459876 65955420    0    0     0     0 76582 70564 39  8 53  0  0
48  0      0 28857424 459876 65955892    0    0     0   548 78658 65494 47  8 46  0  0
 6  0      0 28857180 459876 65956556    0    0     0   412 68303 58902 50  7 43  0  0
 6  0      0 28857100 459876 65956920    0    0     0     0 74057 68416 43  7 50  0  0
 8  0      0 28857544 459884 65957712    0    0     0    72 69953 67101 40  6 54  0  0
13  0      0 28855536 459884 65958852    0    0     0     0 71030 67537 38  7 55  0  0
 5  0      0 28852844 459884 65959508    0    0     0    12 72881 68292 39  7 54  0  0
 6  0      0 28852828 459884 65959928    0    0     0     0 76048 72666 36  7 56  0  0
11  0      0 28851460 459884 65960936    0    0     0     0 68764 65955 37  7 57  0  0
 8  0      0 28850576 459892 65961668    0    0     0   104 68295 64576 43  8 49  0  0
 6  0      0 28852332 459892 65962540    0    0     0     0 70359 67071 31  6 62  0  0
 5  0      0 28848764 459892 65962976    0    0     0   696 82190 74064 36  8 56  0  0
43  0      0 28847140 459892 65963624    0    0     0   400 61498 52562 57  6 38  0  0
15  0      0 28846988 459892 65964452    0    0     0     0 67797 59960 49  7 44  0  0
 5  0      0 28847172 459900 65964636    0    0     0    88 74791 68039 44  7 49  0  0
12  0      0 28845816 459900 65964956    0    0     0     0 71094 67617 44  7 49  0  0
 6  0      0 28843320 459900 65965452    0    0     0    20 69252 61327 50  7 42  0  0
```
节点load负载情况
![](http://oss.zrbcool.top/picgo/mix-deploy-perf-issue-02.png)
可见CPU使用率下降后，应用性能恢复
![](http://oss.zrbcool.top/picgo/mix-deploy-perf-issue-01.png)
